<!DOCTYPE html>
<html>
<head>
  <title>Sicilia MeteoHub – PRO (Dark Relief)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.css" />
  <script src="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.js"></script>

  <script src="https://d3js.org/d3.v7.min.js"></script>

<style>
body { margin:0; background:#111; color:white; font-family:Segoe UI,sans-serif; }
#map { position:absolute; top:0; bottom:0; width:100%; }

/* hillshade molto visibile */
.hillshade {
  mix-blend-mode: multiply;
  filter: contrast(2.0) brightness(0.9);
}

canvas { image-rendering:auto; }
</style>
</head>

<body>
<div id="map"></div>

<script>
let map, velocityLayer;
let heatCanvas, isoCanvas;
let currentData=null;
let activeLayer='wind';
let isLight=false;

/* ===== MAP ===== */
map = L.map('map',{zoomControl:false}).setView([37.5,14.2],8);

/* base dark */
const darkBase = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
  {maxZoom:19}
).addTo(map);

/* hillshade RELIEF */
const hillshade = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}',
  {opacity:0.75,className:'hillshade'}
).addTo(map);

/* labels */
const darkLabels = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png'
).addTo(map);

/* base chiara */
const lightBase = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
);

/* ===== CANVAS ISOBARE ===== */
isoCanvas = L.DomUtil.create('canvas','leaflet-layer');
isoCanvas.style.pointerEvents='none';
map.getPanes().overlayPane.appendChild(isoCanvas);

/* ===== LOAD DATA ===== */
fetch('data_weather/catalog.json')
.then(r=>r.json())
.then(cat=>{
  fetch('data_weather/'+cat[0].file)
  .then(r=>r.json())
  .then(d=>{
    currentData=d;
    drawIsobars();
    drawWind();
  });
});

/* ===== ISOBARE ===== */
function drawIsobars(){
  if(!currentData) return;
  const ctx=isoCanvas.getContext('2d');
  const s=map.getSize();
  isoCanvas.width=s.x;
  isoCanvas.height=s.y;
  ctx.clearRect(0,0,s.x,s.y);

  const m=currentData.meta;
  const press=currentData.press;
  if(!press||press.length!==m.nx*m.ny) return;

  const contours=d3.contours()
    .size([m.nx,m.ny])
    .thresholds(d3.range(960,1050,2))(press);

  ctx.lineWidth=1.4;
  ctx.strokeStyle="white";      // ✅ BIANCHE SU DARK
  ctx.font="bold 12px Arial";
  ctx.textAlign="center";
  ctx.textBaseline="middle";

  contours.forEach(c=>{
    ctx.beginPath();
    c.coordinates.forEach(ring=>{
      ring.forEach(pts=>{
        let first=true;
        pts.forEach(p=>{
          const lat=m.la1-(p[1]*m.dy);
          const lon=m.lo1+(p[0]*m.dx);
          const pt=map.latLngToContainerPoint([lat,lon]);
          if(first){ctx.moveTo(pt.x,pt.y);first=false;}
          else ctx.lineTo(pt.x,pt.y);
        });
      });
    });
    ctx.stroke();
  });
}

/* ===== WIND ===== */
function drawWind(){
  if(velocityLayer) map.removeLayer(velocityLayer);
  if(!currentData) return;

  /* palette diversa se light */
  const windColorsDark=[
    "#000080","#0044ff","#00ddff","#00ff55",
    "#ffff00","#ff6600","#ff0000","#ff00ff"
  ];

  const windColorsLight=[
    "#000000","#222222","#444444","#006400",
    "#8b0000","#ff4500","#b00000"
  ];

  velocityLayer=L.velocityLayer({
    data:[currentData.wind_u,currentData.wind_v],
    maxVelocity:18,
    velocityScale:0.006,
    particleMultiplier: isLight ? 1/180 : 1/140,
    lineWidth:1.0,
    particleAge:140,
    frameRate:60,
    opacity:1.0,
    colorScale: isLight ? windColorsLight : windColorsDark
  }).addTo(map);
}

/* ===== SWITCH MAP ===== */
function setLightMode(on){
  isLight=on;
  if(on){
    map.removeLayer(darkBase);
    map.removeLayer(hillshade);
    map.removeLayer(darkLabels);
    lightBase.addTo(map);
  }else{
    map.removeLayer(lightBase);
    darkBase.addTo(map);
    hillshade.addTo(map);
    darkLabels.addTo(map);
  }
  drawWind();
  drawIsobars();
}

/* esempio toggle */
map.on('dblclick',()=>setLightMode(!isLight));

map.on('moveend',()=>{drawIsobars();});
</script>
</body>
</html>
