<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteo CORE</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body { margin: 0; background: #222; color: #fff; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        #status { position: fixed; top: 10px; left: 10px; background: red; padding: 10px; z-index: 9999; }
        #controls { position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: #000; padding: 10px; }
    </style>
</head>
<body>

<div id="status">Caricamento...</div>
<div id="controls">
    <button onclick="loadData()">RICARICA DATI</button>
    <span id="info">--</span>
</div>
<div id="map"></div>

<script>
    // 1. GESTIONE ERRORI
    window.onerror = function(msg) {
        document.getElementById('status').innerText = "ERRORE: " + msg;
        return false;
    };

    var map;

    // 2. AVVIO
    window.onload = function() {
        document.getElementById('status').innerText = "Avvio Mappa...";
        
        try {
            map = L.map('map').setView([37.5, 14.0], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            document.getElementById('status').innerText = "Mappa OK. Scarico Dati...";
            document.getElementById('status').style.background = "orange";
            
            loadData();
        } catch(e) {
            document.getElementById('status').innerText = "CRASH: " + e.message;
        }
    };

    // 3. DATI
    async function loadData() {
        try {
            // Scarica Catalogo
            let r = await fetch('data_weather/catalog.json?t=' + Date.now());
            if(!r.ok) throw new Error("No Catalog (404)");
            
            let catalog = await r.json();
            document.getElementById('status').innerText = "Catalogo OK: " + catalog.length + " files";
            document.getElementById('status').style.background = "green";
            
            // Scarica Primo File
            let r2 = await fetch('data_weather/' + catalog[0].file);
            let data = await r2.json();
            
            document.getElementById('info').innerText = "Dati Caricati: " + catalog[0].label;
            
            // Disegna Punti Semplici (Test)
            let m = data.meta;
            // Disegniamo solo un rettangolo blu sulla sicilia per vedere se funziona
            L.rectangle([[m.la1, m.lo1], [m.la2, m.lo2]], {color: "#ff7800", weight: 1}).addTo(map);

        } catch(e) {
            document.getElementById('status').innerText = "FALLITO: " + e.message;
            document.getElementById('status').style.background = "red";
        }
    }
</script>

</body>
</html>
