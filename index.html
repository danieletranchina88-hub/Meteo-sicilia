<!DOCTYPE html>
<html>
<head>
    <title>Sicilia MeteoHub - ICON 2I</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-velocity/1.8.0/leaflet-velocity.css" />
    
    <style>
        body { margin: 0; padding: 0; background: #222; font-family: 'Segoe UI', sans-serif; color: white; }
        #map { position: absolute; top: 0; bottom: 50px; width: 100%; background: #222; }
        
        /* Controlli UI (Slider in basso) */
        #controls {
            position: absolute; bottom: 0; left: 0; right: 0; height: 50px;
            background: rgba(20, 20, 20, 0.95); display: flex; align-items: center;
            padding: 0 20px; z-index: 2000; border-top: 1px solid #444;
        }
        input[type=range] { flex-grow: 1; margin: 0 15px; cursor: pointer; accent-color: #00ccff; }
        #time-label { min-width: 140px; text-align: center; font-weight: bold; color: #00ccff; font-size: 1.1em; }

        /* Picker Box (Dati al puntatore) */
        #picker-box {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: rgba(0, 0, 0, 0.85); padding: 15px; border-radius: 8px;
            width: 200px; box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            border: 1px solid #444;
            pointer-events: none;
        }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.95em; }
        .val { font-weight: bold; color: #fff; }
        .lbl { color: #aaa; }
        h3 { margin: 0 0 10px 0; font-size: 1em; text-transform: uppercase; color: #888; border-bottom: 1px solid #444; padding-bottom: 5px; letter-spacing: 1px; }

        /* Loader */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 15px 30px; 
            z-index: 3000; border-radius: 30px; border: 1px solid #555; display: none;
        }
    </style>
</head>
<body>

<div id="loader">Caricamento dati...</div>

<div id="picker-box">
    <h3>Sicilia Live</h3>
    <div class="data-row"><span class="lbl">Temperatura:</span> <span id="val-temp" class="val">--</span> °C</div>
    <div class="data-row"><span class="lbl">Vento:</span> <span id="val-wind" class="val">--</span> km/h</div>
    <div class="data-row"><span class="lbl">Precipitazioni:</span> <span id="val-rain" class="val">--</span> mm</div>
    <div class="data-row"><span class="lbl">Pressione:</span> <span id="val-press" class="val">--</span> hPa</div>
    <div style="font-size:0.7em; color:#555; margin-top:8px; text-align:right;">ICON-2I @ ItaliaMeteo</div>
</div>

<div id="map"></div>

<div id="controls">
    <div style="font-size:1.5em; cursor:pointer;" onclick="togglePlay()">&#9658;</div>
    <input type="range" id="time-slider" min="0" max="0" value="0" step="1">
    <div id="time-label">Caricamento...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-velocity/1.8.0/leaflet-velocity.min.js"></script>

<script>
    // --- 1. Inizializzazione Mappa (CartoDB Dark) ---
    var map = L.map('map', {
        zoomControl: false // Spostiamo lo zoom se serve, per ora pulito
    }).setView([37.5, 14.0], 8);

    L.control.zoom({ position: 'topleft' }).addTo(map);

    // Mappa Base Scura (GRATIS e STABILE)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    var velocityLayer = null;
    var currentData = null;
    var catalog = [];
    var isPlaying = false;

    // --- 2. Gestione Dati ---
    async function loadCatalog() {
        try {
            // Aggiungiamo un timestamp per evitare che il browser usi la cache vecchia
            let r = await fetch('data_weather/catalog.json?t=' + new Date().getTime());
            if (!r.ok) throw new Error("Catalog non trovato");
            
            catalog = await r.json();
            
            let slider = document.getElementById('time-slider');
            slider.max = catalog.length - 1;
            slider.value = 0;
            
            loadStep(0); // Carica il primo step
            
            slider.addEventListener('input', (e) => loadStep(parseInt(e.target.value)));

        } catch (e) {
            console.error(e);
            document.getElementById('time-label').innerText = "In attesa dati...";
        }
    }

    async function loadStep(index) {
        if (!catalog[index]) return;
        
        document.getElementById('time-label').innerText = catalog[index].label;
        let file = 'data_weather/' + catalog[index].file;
        
        // Loader visibile solo se ci mette un po'
        let loaderTimeout = setTimeout(() => document.getElementById('loader').style.display = 'block', 200);

        try {
            let r = await fetch(file);
            currentData = await r.json();
            updateMap(currentData);
        } catch (e) {
            console.error("Errore caricamento step:", e);
        }
        
        clearTimeout(loaderTimeout);
        document.getElementById('loader').style.display = 'none';
    }

    function updateMap(data) {
        if (velocityLayer) map.removeLayer(velocityLayer);

        let velocityData = [
            {
                header: {
                    parameterNumberName: "Eastward current",
                    dx: data.meta.dx, dy: data.meta.dy,
                    la1: data.meta.la1, lo1: data.meta.lo1,
                    nx: data.meta.nx, ny: data.meta.ny
                },
                data: data.wind_u
            },
            {
                header: {
                    parameterNumberName: "Northward current",
                    dx: data.meta.dx, dy: data.meta.dy,
                    la1: data.meta.la1, lo1: data.meta.lo1,
                    nx: data.meta.nx, ny: data.meta.ny
                },
                data: data.wind_v
            }
        ];

        velocityLayer = L.velocityLayer({
            displayValues: false,
            data: velocityData,
            maxVelocity: 20, // Velocità massima per scala colori
            velocityScale: 0.008, // Lunghezza scie
            colorScale: ["#a0a0a0", "#ffffff"], // Bianco/Grigio per contrasto su mappa scura
            lineWidth: 2,
            particleMultiplier: 1/800 // Densità particelle
        });
        velocityLayer.addTo(map);
    }

    // --- 3. Il Picker (Interattività Mouse) ---
    map.on('mousemove', function(e) {
        if (!currentData) return;

        let meta = currentData.meta;
        let lat = e.latlng.lat;
        let lng = e.latlng.lng;

        // Calcolo indici griglia
        let dy = (meta.la1 - lat) / meta.dy;
        let dx = (lng - meta.lo1) / meta.dx;
        
        let y = Math.round(dy); 
        let x = Math.round(dx);

        if (x >= 0 && x < meta.nx && y >= 0 && y < meta.ny) {
            let idx = y * meta.nx + x;

            // Leggi e formatta
            let t = currentData.temp[idx];
            let r = currentData.rain[idx];
            let p = currentData.press[idx];
            let u = currentData.wind_u[idx];
            let v = currentData.wind_v[idx];
            let w = Math.sqrt(u*u + v*v) * 3.6; // km/h

            // Aggiorna HTML
            document.getElementById('val-temp').innerText = t ? t.toFixed(1) : "--";
            document.getElementById('val-wind').innerText = w ? w.toFixed(1) : "--";
            document.getElementById('val-rain').innerText = r >= 0 ? r.toFixed(1) : "0.0";
            document.getElementById('val-press').innerText = p > 0 ? p.toFixed(0) : "--";
        } else {
            document.getElementById('val-temp').innerText = "--";
        }
    });

    // Funzione Play/Pause semplice
    function togglePlay() {
        if (isPlaying) return;
        isPlaying = true;
        let slider = document.getElementById('time-slider');
        let i = parseInt(slider.value);
        let max = parseInt(slider.max);
        
        let interval = setInterval(() => {
            if (i >= max) {
                clearInterval(interval);
                isPlaying = false;
            } else {
                i++;
                slider.value = i;
                loadStep(i);
            }
        }, 1000); // 1 secondo per frame
    }

    // Avvio
    loadCatalog();

</script>
</body>
</html>
