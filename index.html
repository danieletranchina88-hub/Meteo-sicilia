<!DOCTYPE html>
<html>
<head>
    <title>Sicilia MeteoHub - STABLE</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.css" />
    <script src="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body { margin: 0; background: #050505; font-family: sans-serif; color: white; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; background: #050505; }
        
        /* DIAGNOSTICA */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 20px 40px; border-radius: 10px; 
            z-index: 9999; font-weight: bold; border: 1px solid #555; text-align: center;
        }
        #error-box { color: #ff5555; display: none; margin-top: 10px; font-size: 0.9em; white-space: pre-wrap; }

        /* UI */
        #layer-menu {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: rgba(20,20,20,0.9); padding: 8px; border-radius: 8px; 
            display: flex; flex-direction: column; gap: 5px; width: 140px;
        }
        .layer-btn {
            background: #333; color: #ccc; border: none; padding: 8px; border-radius: 4px;
            cursor: pointer; text-align: left; font-size: 13px; display: flex; justify-content: space-between;
        }
        .layer-btn.active { background: #0066cc; color: white; }
        
        #basemap-selector {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(20,20,20,0.9); padding: 5px; border-radius: 8px;
        }
        .base-btn { background: #333; color: #aaa; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .base-btn.active { background: #555; color: #fff; }

        #bottom-bar {
            position: absolute; bottom: 0; width: 100%; height: 80px;
            background: linear-gradient(to top, black, transparent);
            display: flex; align-items: center; padding: 0 20px; z-index: 2000;
        }
        #play-btn { font-size: 2em; cursor: pointer; margin-right: 15px; background: none; border: none; color: white; }
        input[type=range] { flex-grow: 1; margin-right: 20px; }
        
        #picker-box { position: absolute; top: 60px; left: 15px; z-index: 1000; font-size: 2em; font-weight: bold; text-shadow: 2px 2px 0 #000; pointer-events: none; }
        
        canvas.leaflet-layer { image-rendering: pixelated; }
    </style>
</head>
<body>

<div id="loader">
    <div id="status">Avvio Sistema...</div>
    <div id="error-box"></div>
</div>

<div id="basemap-selector">
    <button class="base-btn active" onclick="setBase('dark')">Dark</button>
    <button class="base-btn" onclick="setBase('sat')">Sat</button>
    <button class="base-btn" onclick="setBase('osm')">Map</button>
</div>

<div id="layer-menu">
    <button class="layer-btn active" onclick="setLayer('wind')">VENTO üí®</button>
    <button class="layer-btn" onclick="setLayer('temp')">TEMP üå°Ô∏è</button>
    <button class="layer-btn" onclick="setLayer('rain')">PIOGGIA ‚òî</button>
    <button class="layer-btn" onclick="setLayer('rh')">UMIDIT√Ä üíß</button>
    <button class="layer-btn" onclick="setLayer('press')">PRESS ‚è≤Ô∏è</button>
    <button class="layer-btn" onclick="toggleIsobars()" style="margin-top:5px; border-top:1px solid #555">ISOBARE „Ä∞Ô∏è</button>
    <button class="layer-btn" onclick="toggleGrid()">GRIGLIA #</button>
</div>

<div id="picker-box">--</div>
<div id="map"></div>
<div id="bottom-bar">
    <button id="play-btn" onclick="togglePlay()">‚ñ∫</button>
    <input type="range" id="time-slider" min="0" max="0" value="0">
    <div id="time-label">--/-- --:--</div>
</div>

<script>
    // --- GESTORE ERRORI ---
    function fatalError(msg) {
        document.getElementById('error-box').style.display = 'block';
        document.getElementById('error-box').innerText = msg;
        document.getElementById('status').innerText = "ERRORE";
        document.getElementById('status').style.color = 'red';
    }
    window.onerror = function(msg) { fatalError("JS Error: " + msg); return false; };

    // --- VARIABILI ---
    var map, velocityLayer, heatCanvas, isobarCanvas, gridLayer;
    var currentData = null, catalog = [], activeLayer = 'wind', showIsobars = false, showGrid = false, isPlaying = false;
    var darkLayer, satLayer, osmLayer;

    // --- PALETTE ---
    const PALETTES = {
        temp: [{v:-10,c:[255,255,255,0.6]},{v:0,c:[180,180,255,0.6]},{v:10,c:[0,200,100,0.6]},{v:20,c:[255,255,0,0.6]},{v:30,c:[255,140,0,0.6]},{v:40,c:[200,0,0,0.6]}],
        rain: [{v:0,c:[0,0,0,0]},{v:0.1,c:[0,200,255,0.6]},{v:2,c:[0,0,255,0.7]},{v:10,c:[150,0,200,0.8]}],
        rh:   [{v:20,c:[160,100,50,0.6]},{v:40,c:[200,200,200,0.4]},{v:60,c:[100,255,100,0.5]},{v:80,c:[0,150,255,0.6]},{v:95,c:[0,0,150,0.8]}],
        press:[{v:980,c:[130,0,180,0.8]},{v:995,c:[0,0,255,0.7]},{v:1000,c:[0,150,255,0.6]},{v:1008,c:[100,255,200,0.4]},{v:1013,c:[255,255,255,0.1]},{v:1020,c:[255,200,0,0.5]},{v:1035,c:[255,50,0,0.6]}]
    };

    function getColor(val, type) {
        if (!PALETTES[type]) return [0,0,0,0];
        let stops = PALETTES[type];
        if(type==='rain' && val < 0.1) return [0,0,0,0];
        if(type==='wind' && val < 1) return [0,0,0,0];

        for(let i=0; i<stops.length-1; i++) {
            if(val>=stops[i].v && val<=stops[i+1].v) {
                let t = (val - stops[i].v) / (stops[i+1].v - stops[i].v);
                let c1=stops[i].c, c2=stops[i+1].c;
                return [ Math.round(c1[0]+(c2[0]-c1[0])*t), Math.round(c1[1]+(c2[1]-c1[1])*t), Math.round(c1[2]+(c2[2]-c1[2])*t), c1[3]+(c2[3]-c1[3])*t ];
            }
        } 
        let last = stops[stops.length-1];
        return [last.c[0], last.c[1], last.c[2], last.c[3]];
    }

    // --- SETUP ---
    window.addEventListener('load', function() {
        try {
            map = L.map('map', { zoomControl: false }).setView([37.5, 14.2], 8);
            
            darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png').addTo(map);
            satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, opacity: 0.8 });

            map.createPane('gridPane'); map.getPane('gridPane').style.zIndex = 300; 
            map.createPane('isobarPane'); map.getPane('isobarPane').style.zIndex = 400; map.getPane('isobarPane').style.pointerEvents = 'none';
            map.createPane('labelsPane'); map.getPane('labelsPane').style.zIndex = 500; map.getPane('labelsPane').style.pointerEvents = 'none';
            map.createPane('velocityPane'); map.getPane('velocityPane').style.zIndex = 600; map.getPane('velocityPane').style.pointerEvents = 'none';

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { pane: 'labelsPane' }).addTo(map);

            initRawGridLayer();
            initIsobarLayer();
            initGridLayer();
            loadCatalog();

        } catch(e) { fatalError("Map Init Failed: " + e.message); }
    });

    window.setBase = function(t) {
        map.removeLayer(darkLayer); map.removeLayer(satLayer); map.removeLayer(osmLayer);
        document.querySelectorAll('.base-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if(t==='dark') darkLayer.addTo(map); else if(t==='sat') satLayer.addTo(map); else osmLayer.addTo(map);
    }

    // --- LOAD DATA ---
    async function loadCatalog() {
        document.getElementById('status').innerText = "Scarico Catalogo...";
        try {
            // NOCACHE: Forza il download fresco
            let r = await fetch('data_weather/catalog.json?nocache=' + Date.now());
            if(!r.ok) throw new Error("Catalog 404 Not Found");
            
            catalog = await r.json();
            if(catalog.length === 0) throw new Error("Catalog Empty");

            document.getElementById('time-slider').max = catalog.length - 1;
            document.getElementById('time-slider').addEventListener('input', (e) => loadStep(parseInt(e.target.value)));
            
            loadStep(0);
        } catch(e) {
            fatalError(e.message); 
            // Sblocco di emergenza dopo 2 secondi per non bloccare la UI
            setTimeout(() => document.getElementById('loader').style.display = 'none', 3000);
        }
    }

    async function loadStep(index) {
        if (!catalog[index]) return;
        document.getElementById('time-label').innerText = catalog[index].label;
        document.getElementById('loader').style.display = 'block';
        document.getElementById('status').innerText = "Carico Dati...";
        try {
            let r = await fetch('data_weather/' + catalog[index].file);
            if(!r.ok) throw new Error("File error");
            currentData = await r.json();
            updateMap();
            document.getElementById('loader').style.display = 'none';
        } catch(e) { 
            console.warn(e);
            // Non bloccare, magari il prossimo frame funziona
            document.getElementById('loader').style.display = 'none';
        }
    }

    function updateMap() {
        if (!currentData) return;
        if (heatCanvas) heatCanvas.draw();
        if (isobarCanvas) isobarCanvas.draw();
        if (gridLayer) gridLayer.draw();
        if (velocityLayer) map.removeLayer(velocityLayer);

        if (activeLayer === 'wind' && currentData.wind_u) {
            try {
                velocityLayer = L.velocityLayer({
                    pane: 'velocityPane',
                    displayValues: false,
                    data: [ currentData.wind_u, currentData.wind_v ], 
                    maxVelocity: 18.0, velocityScale: 0.005, particleMultiplier: 1/40, lineWidth: 1.0, frameRate: 60, opacity: 0.90,
                    colorScale: ["#001f4d", "#003380", "#004db3", "#0066e6", "#0088ff", "#00aaff", "#00ccff", "#00ffff", "#33ffcc", "#66ff99", "#99ff66", "#ccff33", "#ffff00", "#ffcc00", "#ff9900", "#ff6600", "#ff3300", "#ff0000"]
                });
                velocityLayer.addTo(map);
            } catch(e) {}
        }
    }

    // --- CANVAS LAYERS ---
    function initRawGridLayer() {
        L.HeatCanvas = L.Layer.extend({
            onAdd: function(m) {
                this._c = L.DomUtil.create('canvas', 'leaflet-layer');
                this._c.style.imageRendering = 'pixelated'; this._c.style.pointerEvents = 'none';
                m.getPane('gridPane').appendChild(this._c);
                m.on('moveend resize', this.draw, this);
                this.draw();
            },
            onRemove: function(m) { m.getPane('gridPane').removeChild(this._c); m.off('moveend resize', this.draw, this); },
            draw: function() {
                if(!this._c || !currentData || activeLayer==='wind') { 
                    if(this._c) this._c.getContext('2d').clearRect(0,0,this._c.width,this._c.height); 
                    return; 
                }
                let s = map.getSize(); this._c.width = s.x; this._c.height = s.y;
                L.DomUtil.setPosition(this._c, map.containerPointToLayerPoint([0,0]));
                
                let ctx = this._c.getContext('2d');
                let m = currentData.meta;
                let b = map.getBounds();
                let showNum = map.getZoom() >= 10;
                ctx.font = "bold 10px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";

                for(let y=0; y<m.ny; y++) {
                    let lat = m.la1 - (y * m.dy);
                    if(lat<b.getSouth()-0.05 || lat>b.getNorth()+0.05) continue;
                    for(let x=0; x<m.nx; x++) {
                        let lon = m.lo1 + (x * m.dx);
                        if(lon<b.getWest()-0.05 || lon>b.getEast()+0.05) continue;

                        let idx = y*m.nx+x;
                        let val = 0;
                        if(activeLayer==='temp') val = currentData.temp[idx];
                        else if(activeLayer==='rain') val = currentData.rain[idx];
                        else if(activeLayer==='rh') val = currentData.rh?currentData.rh[idx]:0;
                        else if(activeLayer==='press') val = currentData.press?currentData.press[idx]:1013;

                        let c = getColor(val, activeLayer);
                        if(c[3]>0) {
                            let p = map.latLngToContainerPoint([lat,lon]);
                            let p2 = map.latLngToContainerPoint([lat-m.dy, lon+m.dx]);
                            let w = Math.ceil(p2.x-p.x)+1, h = Math.ceil(p2.y-p.y)+1;
                            
                            ctx.fillStyle = `rgba(${c[0]},${c[1]},${c[2]},${c[3]})`;
                            ctx.fillRect(Math.floor(p.x), Math.floor(p.y), w, h);

                            if(showNum && val!==0) {
                                ctx.fillStyle="#fff"; 
                                let txt = Math.round(val);
                                if(activeLayer==='rain' && val<1) txt=val.toFixed(1);
                                ctx.fillText(txt, p.x+w/2, p.y+h/2);
                            }
                        }
                    }
                }
            }
        });
        heatCanvas = new L.HeatCanvas();
        map.addLayer(heatCanvas);
    }

    function initIsobarLayer() {
        L.IsoCanvas = L.Layer.extend({
            onAdd: function(m) {
                this._c = L.DomUtil.create('canvas', 'leaflet-layer'); this._c.style.pointerEvents='none';
                m.getPane('isobarPane').appendChild(this._c); m.on('moveend resize', this.draw, this); this.draw();
            },
            onRemove: function(m) { m.getPane('isobarPane').removeChild(this._c); m.off('moveend resize', this.draw, this); },
            draw: function() {
                if(!this._c || !currentData || !showIsobars || !currentData.press) {
                     if(this._c) this._c.getContext('2d').clearRect(0,0,this._c.width,this._c.height);
                     return;
                }
                let s = map.getSize(); this._c.width = s.x; this._c.height = s.y;
                L.DomUtil.setPosition(this._c, map.containerPointToLayerPoint([0,0]));
                let ctx = this._c.getContext('2d');
                let m = currentData.meta;
                
                let contours = d3.contours().size([m.nx, m.ny]).thresholds(d3.range(960, 1050, 2))(currentData.press);
                ctx.lineWidth = 1.2; ctx.font = "bold 13px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";

                contours.forEach(function(c) {
                    ctx.strokeStyle = (c.value < 1013) ? "rgba(200,200,255,0.7)" : "rgba(255,200,200,0.7)";
                    if(Math.abs(c.value-1013)<1) ctx.strokeStyle = "rgba(255,255,255,0.8)";
                    ctx.beginPath();
                    let pathArr = [];
                    c.coordinates.forEach(r => {
                        r.forEach(pts => {
                            let first=true, poly=[];
                            pts.forEach(coord => {
                                let p = map.latLngToContainerPoint([m.la1-(coord[1]*m.dy), m.lo1+(coord[0]*m.dx)]);
                                poly.push(p);
                                if(first) { ctx.moveTo(p.x,p.y); first=false; } else ctx.lineTo(p.x,p.y);
                            });
                            pathArr.push(poly);
                        });
                    });
                    ctx.stroke();
                    pathArr.forEach(pts => {
                        if(pts.length>30) {
                            let mid = pts[Math.floor(pts.length/2)];
                            ctx.fillStyle="rgba(0,0,0,0.8)"; ctx.fillRect(mid.x-14,mid.y-9,28,18);
                            ctx.fillStyle="#fff"; ctx.fillText(Math.round(c.value), mid.x, mid.y);
                        }
                    });
                });
            }
        });
        isobarCanvas = new L.IsoCanvas();
        map.addLayer(isobarCanvas);
    }

    function initGridLayer() {
        L.GridL = L.Layer.extend({
            onAdd: function(m) {
                this._c = L.DomUtil.create('canvas', 'leaflet-layer'); this._c.style.pointerEvents='none';
                m.getPane('isobarPane').appendChild(this._c); m.on('moveend resize', this.draw, this); this.draw();
            },
            onRemove: function(m) { m.getPane('isobarPane').removeChild(this._c); m.off('moveend resize', this.draw, this); },
            draw: function() {
                if(!this._c) return;
                let ctx = this._c.getContext('2d'); ctx.clearRect(0,0,this._c.width,this._c.height);
                if(!showGrid) return;
                let s = map.getSize(); this._c.width = s.x; this._c.height = s.y;
                L.DomUtil.setPosition(this._c, map.containerPointToLayerPoint([0,0]));
                
                let b = map.getBounds();
                let step = map.getZoom()>9 ? 0.1 : 0.5;
                ctx.strokeStyle="rgba(255,255,255,0.3)"; ctx.fillStyle="rgba(255,255,255,0.6)"; ctx.font="10px Mono";

                for(let lon=Math.floor(b.getWest()); lon<=Math.ceil(b.getEast()); lon+=step) {
                    let x = map.latLngToContainerPoint([b.getSouth(),lon]).x;
                    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,s.y); ctx.stroke();
                    ctx.fillText(lon.toFixed(1), x+2, s.y-10);
                }
                for(let lat=Math.floor(b.getSouth()); lat<=Math.ceil(b.getNorth()); lat+=step) {
                    let y = map.latLngToContainerPoint([lat,b.getWest()]).y;
                    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(s.x,y); ctx.stroke();
                    ctx.fillText(lat.toFixed(1), 5, y-2);
                }
            }
        });
        gridLayer = new L.GridL();
        map.addLayer(gridLayer);
    }

    // --- CONTROLS ---
    window.setLayer = function(n) {
        activeLayer=n;
        document.querySelectorAll('.layer-btn').forEach(b=>{ if(!b.textContent.includes('ISO') && !b.textContent.includes('GRI')) b.classList.remove('active'); });
        event.target.classList.add('active');
        document.getElementById('picker-box').innerText="--";
        updateMap();
    }
    window.toggleIsobars=function(){ showIsobars=!showIsobars; event.target.classList.toggle('active'); updateMap(); }
    window.toggleGrid=function(){ showGrid=!showGrid; event.target.classList.toggle('active'); updateMap(); }
    window.togglePlay=function(){
        if(isPlaying) return; isPlaying=true;
        let s=document.getElementById('time-slider'), btn=document.getElementById('play-btn');
        btn.innerText="||";
        let i=parseInt(s.value);
        let int=setInterval(()=>{
            if(i>=parseInt(s.max) || !isPlaying) { clearInterval(int); isPlaying=false; btn.innerText="‚ñ∫"; }
            else { i++; s.value=i; loadStep(i); }
        },800);
    }
    window.addEventListener('load', ()=>{
        map.on('mousemove', e=>{
            if(!currentData) return;
            let m=currentData.meta;
            let y=Math.round((m.la1-e.latlng.lat)/m.dy), x=Math.round((e.latlng.lng-m.lo1)/m.dx);
            if(x>=0 && x<m.nx && y>=0 && y<m.ny) {
                let idx=y*m.nx+x;
                let val = (acti
