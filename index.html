<!DOCTYPE html>
<html>
<head>
    <title>Sicilia MeteoHub - FIX</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.css" />
    <script src="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.js"></script>
    
    <style>
        body { margin: 0; background: #222; font-family: sans-serif; color: white; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; background: #222; }
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.85); color: #0f0; font-family: monospace; font-size: 11px;
            overflow-y: auto; z-index: 9999; padding: 10px; pointer-events: none; border-bottom: 2px solid #0f0;
        }
        #bottom-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 80px; background: rgba(0,0,0,0.8); display: flex; align-items: center; padding: 0 20px; z-index: 5000; }
        input[type=range] { flex-grow: 1; height: 10px; accent-color: #007bff; }
    </style>
</head>
<body>

<div id="debug-console">Avvio sistema...<br></div>
<div id="map"></div>
<div id="bottom-bar">
    <input type="range" id="time-slider" min="0" max="0" value="0" step="1">
</div>

<script>
    function log(msg) {
        var c = document.getElementById('debug-console');
        c.innerHTML += "> " + msg + "<br>";
        c.scrollTop = c.scrollHeight;
    }

    // CONTROLLO LIBRERIE
    if (typeof L === 'undefined') { log("ERRORE CRITICO: Leaflet non caricato!"); }
    else { log("Leaflet OK."); }

    // Inizializza Mappa
    var map = L.map('map', { zoomControl: false }).setView([37.5, 14.2], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

    var velocityLayer = null;
    var catalog = [];

    // Funzione principale
    async function start() {
        // Controllo se il plugin è stato caricato
        if (typeof L.velocityLayer !== 'function') {
            log("ERRORE: Plugin Velocity ANCORA NON CARICATO.");
            log("Provo a caricarlo manualmente...");
            // Tentativo disperato di caricamento backup
            let script = document.createElement('script');
            script.src = "https://cdn.jsdelivr.net/npm/leaflet-velocity@1.8.0/dist/leaflet-velocity.min.js";
            script.onload = () => { log("Backup caricato! Riprova a ricaricare la pagina."); };
            document.head.appendChild(script);
            return;
        } else {
            log("Plugin Velocity RILEVATO! (Finalmente)");
        }

        try {
            let r = await fetch('data_weather/catalog.json?t=' + Date.now());
            if(!r.ok) throw new Error("No catalogo");
            catalog = await r.json();
            log("Catalogo scaricato: " + catalog.length + " step.");
            
            document.getElementById('time-slider').max = catalog.length - 1;
            document.getElementById('time-slider').addEventListener('input', (e) => loadStep(parseInt(e.target.value)));
            
            loadStep(0);
        } catch(e) { log("Errore rete: " + e.message); }
    }

    async function loadStep(index) {
        if (!catalog[index]) return;
        try {
            let r = await fetch('data_weather/' + catalog[index].file);
            let data = await r.json();
            
            // Log Dati
            let u = data.wind_u.data;
            let max = 0;
            for(let i=0; i<u.length; i+=100) if(Math.abs(u[i])>max) max=Math.abs(u[i]);
            log(`Step ${index}: Vento Max ${max.toFixed(1)} m/s`);

            if (velocityLayer) map.removeLayer(velocityLayer);

            velocityLayer = L.velocityLayer({
                displayValues: true,
                displayOptions: { position: 'bottomleft', emptyString: 'No Data' },
                data: [ data.wind_u, data.wind_v ],
                maxVelocity: 15,
                velocityScale: 0.02,     // Lunghezza scia
                colorScale: ["#ffffff"], // BIANCO
                lineWidth: 3,            // Spessore
                particleMultiplier: 1/150 // Densità
            });
            velocityLayer.addTo(map);
            log("Layer aggiunto alla mappa.");

        } catch(e) { log("Errore visualizzazione: " + e.message); }
    }

    // Ritardiamo l'avvio di 1 secondo per dare tempo al plugin di caricarsi
    setTimeout(start, 1000);

</script>
</body>
</html>
