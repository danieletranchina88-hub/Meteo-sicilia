<!DOCTYPE html>
<html>
<head>
  <title>Sicilia MeteoHub - FINAL FULL (Velocity)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Wind particles engine (Windy-like) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.js" crossorigin=""></script>

  <style>
    body { margin: 0; background: #000; font-family: monospace; color: white; overflow: hidden; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; background: #000; }

    /* DEBUG BOX */
    #debug-console {
      position: absolute; bottom: 100px; right: 10px; width: 240px; height: 140px;
      background: rgba(0,0,0,0.85); color: #00ff00;
      padding: 6px; border: 1px solid #00ff00;
      z-index: 9999; overflow-y: auto; font-size: 10px;
      pointer-events: none; opacity: 0.85;
    }

    #layer-menu {
      position: absolute; top: 15px; right: 15px; z-index: 1000;
      background: rgba(30,30,30,0.9); padding: 8px; border-radius: 12px;
      display: flex; flex-direction: column; gap: 8px; border: 1px solid #444;
    }
    .layer-btn {
      background: transparent; border: none; color: #ccc; padding: 12px 20px;
      font-size: 14px; font-weight: 600; cursor: pointer; text-align: right;
      border-radius: 8px; font-family: sans-serif;
    }
    .layer-btn.active { background: #007bff; color: white; }

    #picker-box {
      position: absolute; top: 20px; left: 20px; z-index: 1000;
      pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,1); font-family: sans-serif;
    }
    .picker-val { font-size: 3.5em; font-weight: 800; line-height: 1; }
    .picker-unit { font-size: 1.2em; color: #ccc; }
    .picker-lbl { font-size: 0.8em; color: #aaa; text-transform: uppercase; margin-top: 5px; font-weight: bold;}

    #bottom-bar {
      position: absolute; bottom: 0; left: 0; right: 0; height: 90px;
      background: linear-gradient(to top, #000, transparent);
      display: flex; align-items: center; padding: 0 25px 20px 25px; z-index: 2000;
    }
    #play-btn { font-size: 2.5em; cursor: pointer; margin-right: 25px; font-family: sans-serif; }
    input[type=range] { flex-grow: 1; height: 6px; cursor: pointer; accent-color: #007bff; }
    #time-label { min-width: 170px; text-align: center; font-weight: bold; font-size: 1.2em; font-family: sans-serif; }

    #loader {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85); padding: 20px 40px; border-radius: 30px;
      z-index: 5000; display: none; font-weight: bold; font-family: sans-serif;
    }
  </style>
</head>
<body>

<div id="loader">Caricamento...</div>
<div id="debug-console">Console Ready.<br></div>

<div id="layer-menu">
  <button class="layer-btn active" id="btn-wind" onclick="setLayer('wind', this)">VENTO üí®</button>
  <button class="layer-btn" id="btn-temp" onclick="setLayer('temp', this)">TEMP üå°Ô∏è</button>
  <button class="layer-btn" id="btn-rain" onclick="setLayer('rain', this)">PIOGGIA ‚òî</button>
</div>

<div id="picker-box">
  <div id="pk-val" class="picker-val">--</div>
  <div id="pk-unit" class="picker-unit">km/h</div>
  <div id="pk-lbl" class="picker-lbl">VENTO</div>
</div>

<div id="map"></div>

<div id="bottom-bar">
  <div id="play-btn" onclick="togglePlay()">&#9658;</div>
  <input type="range" id="time-slider" min="0" max="0" value="0" step="1">
  <div id="time-label">--/-- --:--</div>
</div>

<script>
  // --- DEBUG ---
  function log(msg) {
    var d = document.getElementById('debug-console');
    d.innerHTML += "> " + msg + "<br>";
    d.scrollTop = d.scrollHeight;
    console.log(msg);
  }
  window.onerror = function(msg, url, line) {
    log("ERR: " + msg);
    return false;
  };

  var map, velocityLayer, heatCanvas;
  var currentData = null;
  var catalog = [];
  var activeLayer = 'wind';
  var isPlaying = false;
  var playTimer = null;

  // --- PALETTE COLORI ---
  const PALETTES = {
    temp: [
      {val:-10,c:[255,255,255]},{val:0,c:[200,200,255]},{val:10,c:[0,200,100]},
      {val:20,c:[255,255,0]},{val:30,c:[255,140,0]},{val:40,c:[200,0,0]}
    ],
    rain: [
      {val:0,c:[0,0,0,0]},{val:0.2,c:[0,150,255]},{val:5,c:[0,0,255]},{val:20,c:[150,0,150]}
    ],
    wind: [
      {val:0,c:[0,0,0,0]},{val:5,c:[0,100,200]},{val:20,c:[0,200,0]},{val:40,c:[200,200,0]},
      {val:60,c:[255,0,0]},{val:90,c:[120,0,0]}
    ]
  };

  function getColor(val, type) {
    let stops = PALETTES[type];
    if(type==='rain'
