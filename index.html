    <!DOCTYPE html>
<html>
<head>
    <title>Sicilia MeteoHub - DEBUG MODE</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.css" />
    <script src="https://unpkg.com/leaflet-velocity@1.8.0/dist/leaflet-velocity.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body { margin: 0; background: #050505; font-family: 'Segoe UI', Roboto, sans-serif; color: white; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; background: #050505; }
        
        /* DIAGNOSTICA */
        #debug-console {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); padding: 30px; border-radius: 20px; 
            z-index: 9999; max-width: 80%; text-align: center; border: 2px solid #555;
            display: none; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        #debug-title { font-size: 2em; color: #ff5555; margin-bottom: 20px; font-weight: bold; }
        #debug-msg { font-size: 1.2em; color: #fff; font-family: monospace; line-height: 1.5; white-space: pre-wrap; }
        
        /* UI NORMALE */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 30px; 
            z-index: 5000; font-weight: bold; font-size: 1.2em; color: #0088ff; border: 1px solid #333;
        }
        
        #layer-menu {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(20, 20, 20, 0.9); padding: 10px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 5px; border: 1px solid #444;
        }
        .layer-btn {
            background: #333; color: #fff; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;
            text-align: left; font-size: 14px; display: flex; justify-content: space-between;
        }
        .layer-btn.active { background: #0066cc; }
        
        #bottom-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 80px;
            background: linear-gradient(to top, #000, transparent);
            display: flex; align-items: center; padding: 0 20px; z-index: 2000;
        }
        input[type=range] { flex-grow: 1; margin: 0 20px; cursor: pointer; }
        #time-label { min-width: 150px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader">Avvio Sistema...</div>

<div id="debug-console">
    <div id="debug-title">‚ö†Ô∏è ERRORE RILEVATO</div>
    <div id="debug-msg">Caricamento...</div>
</div>

<div id="map"></div>

<div id="layer-menu">
    <button class="layer-btn active" onclick="setLayer('wind')">VENTO üí®</button>
    <button class="layer-btn" onclick="setLayer('temp')">TEMP üå°Ô∏è</button>
    <button class="layer-btn" onclick="setLayer('rain')">PIOGGIA ‚òî</button>
    <button class="layer-btn" onclick="setLayer('rh')">UMIDIT√Ä üíß</button>
    <button class="layer-btn" onclick="setLayer('press')">PRESSIONE ‚è≤Ô∏è</button>
    <button class="layer-btn" onclick="toggleIsobars()" style="margin-top:5px; border-top:1px solid #555">ISOBARE „Ä∞Ô∏è</button>
</div>

<div id="bottom-bar">
    <button onclick="togglePlay()" style="background:none; border:none; color:white; font-size:2em; cursor:pointer">‚ñ∫</button>
    <input type="range" id="time-slider" min="0" max="0" value="0">
    <div id="time-label">--:--</div>
</div>

<script>
    // --- GESTORE ERRORI GLOBALE (Cattura tutto) ---
    window.onerror = function(msg, url, line) {
        showError(`Errore JS: ${msg}\nLinea: ${line}`);
        return false;
    };

    function showError(text) {
        document.getElementById('loader').style.display = 'none';
        let box = document.getElementById('debug-console');
        box.style.display = 'block';
        document.getElementById('debug-msg').innerText = text;
        console.error(text);
    }

    // --- VARIABILI ---
    var map, velocityLayer, heatCanvas, isobarCanvas;
    var currentData = null;
    var catalog = [];
    var activeLayer = 'wind';
    var showIsobars = false;
    
    // PALETTE COLORI
    const PALETTES = {
        temp: [{v:-10,c:[255,255,255]},{v:0,c:[180,180,255]},{v:10,c:[0,200,100]},{v:20,c:[255,255,0]},{v:30,c:[255,140,0]},{v:40,c:[200,0,0]}],
        rain: [{v:0,c:[0,0,0,0]},{v:0.1,c:[0,200,255]},{v:5,c:[0,0,255]},{v:20,c:[150,0,200]}],
        rh:   [{v:20,c:[200,150,50]},{v:50,c:[200,200,200]},{v:80,c:[50,150,255]},{v:95,c:[0,0,200]}],
        press:[{v:980,c:[100,0,200]},{v:1000,c:[0,100,255]},{v:1013,c:[0,255,100,0]},{v:1030,c:[255,100,0]}]
    };

    function getColor(val, type) {
        let p = PALETTES[type];
        if(!p) return [0,0,0,0];
        if(type==='rain' && val<0.1) return [0,0,0,0];
        if(type==='press' && Math.abs(val-1013)<2) return [0,0,0,0]; // Trasparenza su pressione media

        for(let i=0; i<p.length-1; i++) {
            if(val>=p[i].v && val<=p[i+1].v) {
                let t = (val-p[i].v)/(p[i+1].v-p[i].v);
                let c1=p[i].c, c2=p[i+1].c;
                // Gestione alpha opzionale
                let a1 = c1.length>3?c1[3]:0.6, a2 = c2.length>3?c2[3]:0.6;
                return [
                    c1[0]+(c2[0]-c1[0])*t,
                    c1[1]+(c2[1]-c1[1])*t,
                    c1[2]+(c2[2]-c1[2])*t,
                    a1+(a2-a1)*t
                ];
            }
        }
        return [p[p.length-1].c[0], p[p.length-1].c[1], p[p.length-1].c[2], 0.6];
    }

    // --- AVVIO ---
    window.addEventListener('load', async function() {
        document.getElementById('loader').innerText = "Caricamento Mappa...";
        
        // Check Librerie
        if(typeof L === 'undefined') { showError("Libreria Leaflet non caricata.\nControlla la connessione internet."); return; }
        
        try {
            map = L.map('map', { zoomControl: false }).setView([37.5, 14.2], 8);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png').addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {zIndex:600}).addTo(map);

            // Layer Canvas Custom
            initCanvasLayer(); 
            
            // Caricamento Dati
            await loadCatalog();
            
        } catch(e) {
            showError("Errore Inizializzazione:\n" + e.message);
        }
    });

    // --- LOGICA DATI ---
    async function loadCatalog() {
        document.getElementById('loader').innerText = "Lettura Catalogo...";
        try {
            let r = await fetch('data_weather/catalog.json?nocache=' + Date.now());
            if(!r.ok) {
                if(r.status === 404) throw new Error("File catalog.json NON trovato.\nLa cartella data_weather √® vuota?");
                throw new Error("Errore Network: " + r.status);
            }
            catalog = await r.json();
            
            if(!catalog || catalog.length === 0) {
                showError("Il catalogo √® VUOTO.\nNessun dato meteo disponibile.");
                return;
            }

            let s = document.getElementById('time-slider');
            s.max = catalog.length - 1;
            s.addEventListener('input', (e) => loadStep(e.target.value));
            
            // Carica primo frame
            await loadStep(0);

        } catch(e) {
            // Rileva blocco CORS (file://)
            if(window.location.protocol === 'file:' && e.message.includes('Network')) {
                showError("BLOCCO DI SICUREZZA BROWSER\n\nNon puoi aprire index.html con doppio clic.\nUsa un server locale o caricalo su GitHub.");
            } else {
                showError(e.message);
            }
        }
    }

    async function loadStep(idx) {
        if(!catalog[idx]) return;
        document.getElementById('time-label').innerText = catalog[idx].label;
        
        try {
            let r = await fetch('data_weather/' + catalog[idx].file);
            if(!r.ok) throw new Error("File frame mancante: " + catalog[idx].file);
            currentData = await r.json();
            updateMap();
            document.getElementById('loader').style.display = 'none'; // TUTTO OK
        } catch(e) {
            console.error(e);
            // Non bloccare tutto, solo avviso log
        }
    }

    function updateMap() {
        if(!currentData) return;
        
        // 1. Rimuovi vecchio vento
        if(velocityLayer) map.removeLayer(velocityLayer);
        
        // 2. Disegna Sfondo (Canvas)
        if(heatCanvas) heatCanvas.draw();

        // 3. Disegna Vento (Se attivo)
        if(activeLayer === 'wind' && currentData.wind_u) {
            try {
                velocityLayer = L.velocityLayer({
                    displayValues: false,
                    data: [currentData.wind_u, currentData.wind_v],
                    maxVelocity: 15, velocityScale: 0.005, opacity: 0.9, colorScale: ["#fff"]
                });
                velocityLayer.addTo(map);
            } catch(e) { console.log("Err vento:", e); }
        }
        
        // 4. Isobare (Se attive)
        if(showIsobars && currentData.press) drawIsobars();
    }

    // --- SISTEMA CANVAS SEMPLIFICATO ---
    function initCanvasLayer() {
        L.CustomLayer = L.Layer.extend({
            onAdd: function(m) {
                this._c = L.DomUtil.create('canvas', 'leaflet-layer');
                this._c.style.pointerEvents = 'none';
                m.getPanes().overlayPane.appendChild(this._c);
                m.on('moveend resize', this.draw, this);
                this.draw();
            },
            onRemove: function(m) { m.getPanes().overlayPane.removeChild(this._c); m.off('moveend resize', this.draw, this); },
            draw: function() {
                if(!this._c || !currentData) return;
                let s = this._map.getSize();
                this._c.width = s.x; this._c.height = s.y;
                L.DomUtil.setPosition(this._c, this._map.containerPointToLayerPoint([0,0]));
                
                let ctx = this._c.getContext('2d');
                let m = currentData.meta;
                
                // Disegna solo se non √® vento
                if(activeLayer === 'wind') return;

                // Loop pixel
                for(let y=0; y<m.ny; y++) {
                    let lat = m.la1 - (y*m.dy);
                    for(let x=0; x<m.nx; x++) {
                        let lon = m.lo1 + (x*m.dx);
                        let pt = map.latLngToContainerPoint([lat, lon]);
                        
                        // Ottimizzazione viewport
                        if(pt.x<-10 || pt.x>s.x+10 || pt.y<-10 || pt.y>s.y+10) continue;

                        let idx = y*m.nx + x;
                        let val = 0;
                        if(activeLayer==='temp') val = currentData.temp[idx];
                        else if(activeLayer==='rain') val = currentData.rain[idx];
                        else if(activeLayer==='rh') val = currentData.rh?currentData.rh[idx]:0;
                        else if(activeLayer==='press') val = currentData.press?currentData.press[idx]:1013;

                        let c = getColor(val, activeLayer);
                        if(c[3] > 0) {
                            ctx.fillStyle = `rgba(${c[0]},${c[1]},${c[2]},${c[3]})`;
                            // Dimensione pixel dinamica per coprire buchi
                            ctx.fillRect(pt.x, pt.y, Math.ceil(s.x/m.nx*2.5), Math.ceil(s.y/m.ny*2.5));
                        }
                    }
                }
            }
        });
        heatCanvas = new L.CustomLayer();
        map.addLayer(heatCanvas);
    }
    
    // --- FUNZIONI UI ---
    window.setLayer = function(l) { activeLayer = l; updateMap(); }
    window.toggleIsobars = function() { showIsobars = !showIsobars; updateMap(); }
    window.togglePlay = function() {/* Logica play omessa per brevit√† */}

    // --- D3 ISOBARE (Minimal) ---
    function drawIsobars() {
        // Implementazione semplificata per debug (omessa per non appesantire)
        // Se serve, riattivo quella completa.
    }

</script>
</body>
</html>
